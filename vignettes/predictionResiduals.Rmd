---
title: North Atlantic Swordfish
subtitle: Prediction Residuals
author: "Laurence Kell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: word_document
---

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { 
      equationNumbers: { 
            autoNumber: "AMS",
            formatNumber: function (n) {return ''+n}
      } 
  }
});
</script>


#Bugs
```{r, bugs, eval=FALSE}
library(mpb)
library(plyr)

## should be example dataset
data(swon)

## problem with only 1 flQuant in FLQuants
jk=jackknife(swon,FLQuants("1"=jackknife(swon@indices[[1]])))

#should return an FLQuantJK
"FLQuantJK"%in%is(catch(jk)[,1:10]%/%stock(jk)[,1:10])

#should return an FLParJK
"FLQuantJK"%in%is(refpts(jk)) 

## would be nice if it were an FLPar
rbind(params(jk))

(params(jk)%-%orig(params(jk)))%/%params(params(jk))

## not working
orig(params(jk))=orig(params(jk))

## not working
indices(jk)<-indices(bds[[1]])

## not working
stock(jk)<-stock(jk)

# lots of @ in biodyn
```


Here is an example for mpb that runs

+  Jackknife
+  leave-one-out crossvalidation, this is the same algorithm as the jackknife the post processing is different.
+  hindcast, i.e. retrospective tail cutting with projection for cut years. This could be for 1 year in which case the outputs are in the jackknife results. If n>1 then the results are different

Issues are

+  post processing, i.e. methods needed for jackSummary, with signatures of FLQuantJK,FLParJK,FLQuants,FLPars,data.frame, see jackFn
+  prediction residuals, predict out-of-sample predicted value, see presFn
+  dfbeta, i.e. how much does a parameter or derived value change when you remove a point, see dfbetaFn
+  cooks distance etc. from regression of CPUE v biomass, see cksdFn
    
```{r, echo=FALSE}
library(knitr)

opts_chunk$set(comment=NA, 
               fig.width =8, 
               fig.height=5,
               fig.path  ="../tex/mpb-",
               warning=FALSE, 
               message=FALSE, 
               error  =FALSE, 
               echo   =FALSE, 
               eval   =TRUE,
               cache  =TRUE,
               cache.path="cache/predRes")

iFig=0
iTab=0
```

```{r, echo=FALSE}
library(FLCore)
library(ggplotFL)
library(mpb)

library(reshape)
library(plyr)
library(scales)

theme_set(theme_bw(10))

aspic="/home/laurie/Desktop/MEGA/papers/scrs/2017/scrs-2017-102/inputs/aspic/aspic.inp"

dirMy ="/home/laurie/Desktop/MEGA/papers/scrs/2017/scrs-2017-124"
dirDat=file.path(dirMy,"mpb/data")
dirInp=file.path(dirMy,"mpb/inputs")
dirTex=file.path(dirMy,"mpb/tex")
```

```{r func}
jackknifeKey=function(object){
  ## Points that were jackknifed
  orig=ldply(object@indices,function(x) {res=as.data.frame(orig(x),drop=TRUE)
                                         res[!is.na(res$data),]})
  sim =ldply(object@indices,function(x) {res=as.data.frame(x,drop=TRUE)
                                         res[is.na(res$data),]})
  key=merge(sim,orig,by=c(".id","year"))[,-4]
  names(key)[4]="obs"
  
  key}

press=function(object){
  key=jackknifeKey(object)
  
  prsdl=mdply(key,function(.id,year,iter,obs) {
       hat=stock(object,0.5)[,ac(year),,,,iter]%*%params(object)[paste("q",(as.numeric(factor(.id))),sep=""),iter]
       c(log(obs/hat))})
    
  names(prsdl)[5]="residual.p"
  prsdl}

relDif<-function(object){
  n=seq(length(dim(object))-1)
  sweep(sweep(as(object,is(object)[2]),n,orig(object),"-"),n,orig(object),"/")}

dfbetaFn=function(object){
  key=jackknifeKey(object)
  
  t1=relDif(params(object))
  t2=relDif(refpts(object))
  t3=stock(  object)[,ac(dims(catch(object))$maxyear)]
  t4=harvest(object)[,ac(dims(catch(object))$maxyear)]
  t5=relDif(t3%/%bmsy(object))
  t6=relDif(t4%/%fmsy(object))
  
  smryStats=rbind(t1,t2,t3,t4,t5,t6)
  
  smryStats}

cooksdFn=function(bd){
  dgs=subset(diags(bd),!is.na(obs))[,c("year","obs")]
  dat=merge(dgs,as.data.frame(stock(bd,0.5),drop=TRUE))
  
  dat=data.frame(year    =dgs$year,
                 cooksd  =cooks.distance(lm(obs~data-1,dat)),
                 hat     =hatvalues(lm(obs~data-1,dat)),
                 residual=residuals(lm(obs~data-1,dat)))
  dat}

jackSmry<-function(object,sim,...) {
            
    nms =names(dimnames(object))
    idx =seq(length(nms))[nms != 'iter']
    n   =dims(sim)$iter 
          
    mn  =object
    u   =sim
    mnU =apply(u, idx, mean)   
            
    SS =apply(sweep(u, idx, mnU,"-")^2, idx, sum)
            
    bias = (n-1)*(mn-mnU)
    se   = sqrt(((n-1)/n)*SS)
            
  # cov  =FLPar(cov(model.frame(u)[,dimnames(u)[[1]]])*(n-1)*(n-1)/n)
  # cor  =FLPar(cor(cov[drop=T]))
            
    return(FLPars("hat"=mn, "mean"=mnU, "se"=se, "cv"=se%/%mnU,
                  "bias"=bias, "biasRel"=bias/mn))} #bug =bias%/%mnU, "cov"=cov, "cor"=cor))}

```

```{r aspic,fig.width=8,fig.height=8}
asp2013=fit(aspic(aspic))
```

```{r cpue,fig.width=8,fig.height=4}
idx=index(asp2013,FALSE)
#idx[,14]=NA

plot(idx)+
  geom_point()+
  theme_bw()+xlab("Year")+ylab("CPUE")

u=FLQuants("All"=idx,"Short"=window(idx,start=1975))
```
**Figure `r iFig=iFig+1; iFig`.** Time series of CPUE used in the 2013 assessment.

```{r biodyn,fig.width=8,fig.height=10}
source('~/Desktop/flr/mpb/R/biodyn-fit.R')
library(stringr)

bd=as(asp2013,"biodyn")

setParams( bd)=idx
setControl(bd)=params(bd)
control(bd)["q1",c("min","max")]=control(bd)["q1",c("min","max")]*c(0.1,10)
control(bd)["sigma1",c("min","max")]=control(bd)["sigma1",c("min","max")]*c(0.1,10)
control(bd)[c("q1"),"phase"]=2
control(bd)[c("sigma1"),"phase"]=-2

bd=fit(bd,idx[!is.na(idx)])

bdSkew=bd

control(bdSkew)["p","val"]=0.0001
bdSkew=fit(bdSkew,idx[!is.na(idx)])
bds=mpb:::biodyns(list("Logistic"=bd,"Skewed"=bdSkew))
rm(bd,bdSkew)

bds[["Logistic Short"]]=fit(bds[["Logistic"]],u["Short"])
bds[["Skewed Short"]]  =fit(bds[["Skewed"]],  u["Short"])

bds[["Logistic"]]@indices=FLQuants(u["All"])
bds[["Skewed"]]@indices  =FLQuants(u["All"])

bds[["Logistic Short"]]@indices=FLQuants(u["Short"])
bds[["Skewed Short"]]@indices  =FLQuants(u["Short"])

p=plot(bds)+
  scale_fill_brewer(palette = "Set1")
  # scale_colour_manual("Production Function",
  #                       labels = c("Logistic", "Skewed"),
  #                       values = c("#2121D9", "#D92121"))
```

```{r, jk}
jks=mpb:::biodyns(llply(bds,function(x) 
  jackknife(x,FLQuants("1"=jackknife(x@indices[[1]])))))
```

```{r, xval}
hind=ldply(bds, function(bd) mdply(dims(catch(bd))$maxyear-(1:10), function(cut){
         sa=fit(window(bd, end=cut),window(bd@indices[[1]],end=cut))
         sa=fwd(sa,catch=window(catch(bd),start=cut))
         
         model.frame(FLQuants(
                  obs=window(idx,start=cut),
                  hat=window(stock(sa,.5),start=cut)%*%params(sa)["q1"]),drop=TRUE)}))

names(hind)[1:2]=c("Scenario","Cut")
```

```{r, aspic-plot,fig.height=8}
plot(asp2013)+
 theme_bw()
```
**Figure `r iFig=iFig+1; iFig`.** Assessed stock status.

```{r, press}
pres=ldply(jks,press)
```

```{r, dfbeta, fig.height=10}
#(params(jks[[1]])%-%orig(params(jks[[1]])))%/%params(params(jks[[1]]))

sweep(sweep(FLPar(params(jks[[1]])),1,orig(params(jks[[1]])),"-"),1,orig(params(jks[[1]])),"/")


dfb=ldply(jks,dfbetaFn)

ggplot(subset(dfb,!(variable%in%c("p","b0","sigma1","q1"))))+
  geom_point(aes(iter,data,colour=.id))+
  facet_grid(variable~.,scale="free_y",space="free_y")+
  scale_y_continuous(labels=percent)+
  theme_bw()+
  xlab("Year")+ylab("")
```
**Figure `r iFig=iFig+1; iFig`.** 

```{r cooks1,fig.height=6,fig.width=6}
cksd=ldply(bds,cksdFn)


ggplot(cksd)+
  geom_point(aes(hat,abs(residual),size=cooksd))+
  facet_wrap(~.id)+
  theme_bw()+
  theme(legend.position="none")
```
**Figure `r iFig=iFig+1; iFig`.** 

```{r, cooks-plot-2,fig.height=10,fig.width=7}
stat=merge(dfb,cksd,merge="year")
stat=subset(stat,!(variable%in%c("p","b0","sigma1","q1")))
       
stat[stat$cooksd>1,"cooksd"]=0.056
stat$outlier=FALSE

ggplot(stat)+
  geom_point(aes(cooksd,abs(value)))+
  geom_point(aes(cooksd,abs(value)),data=subset(stat,cooksd==0.056),col="red",size=4)+
  geom_label(aes(cooksd,abs(value)),label="1.8",alpha=0.5,data=subset(stat,cooksd==0.056))+
  facet_grid(variable~Scenario,space="free",scale="free")+
  scale_x_continuous(limits=c(0,.06))+
  theme_bw()
```
**Figure `r iFig=iFig+1; iFig`.** 

```{r, hind}
ggplot(subset(hind,Cut%in%c(10:6)),aes(y=log(obs/hat),x=factor(Cut)))+
   geom_hline(aes(yintercept=0))+
   geom_boxplot(fill="grey")+
   geom_point(position=position_dodge(width=0.75),aes(group=factor(year),col=factor(year)))+
   scale_colour_brewer(palette = "Set1")+
   #scale_fill_manual("Production Function",
   #                     labels = c("Logistic", "Skewed"),
  #                     values = c("#E69F00", "#D55E00"))+
   scale_x_discrete(breaks=c(1:5))+
   theme_bw()+xlab("Length of Tail Cut")+ylab("Residual")+
   theme(legend.position="none")+
   facet_wrap(~Scenario)
```
**Figure `r iFig=iFig+1; iFig`.** Comparison of prediction residuals, by CPUE series and production function shape, for different lengths of tail cutting.


```{r, residuals}
ggplot(melt(pres[,c("Scenario","year","residual","p.residual")],id=c("Scenario","year")))+ 
   geom_boxplot(aes(factor(variable,labels=c("Model","Prediction")),value))+
   facet_wrap(~Scenario)+
   theme_bw()+
   xlab("Residual Type")+ylab("")
```
**Figure `r iFig=iFig+1; iFig`.** Comparison of model and prediction residuals, by CPUE series and production function shape.


```{r production}
ts=ldply(bds, function(x) model.frame(mcf(FLQuants(x,"stock","catch"))))
      
plotProduction(bds)+
  geom_path( aes(stock,catch,fill=.id,col=.id),data=ts,shape=21)+      
  geom_point(aes(stock,catch,fill=.id),data=ts,shape=21,col="grey")+  
  scale_fill_brewer(palette = "Set1")+
  scale_colour_brewer(palette = "Set1")+
  # scale_colour_manual("Production Function",
  #                       labels = c("Logistic", "Skewed"),
  #                       values = c("#2121D9", "#D92121"))+
  # scale_fill_manual("Production Function",
  #                       labels = c("Logistic", "Skewed"),
  #                       values = c("#2121D9", "#D92121"))+
  theme_bw()+
  theme(legend.position="none")+
  facet_wrap(~.id)
```
**Figure `r iFig=iFig+1; iFig`.** Production function for the logistic and skewed production functions, historic trajectory also shown.

```{r tab-cor}
cr=ddply(stat,.(Scenario,variable), with, cor(cooksd,value,method="spearman"))

cast(cr,variable~Scenario)

bias=rbind(cbind("Scenario"=names(bds)[1],model.frame(jackFn(params(bds[[1]]),params(jks[[1]]))$bias)),
           cbind("Scenario"=names(bds)[2],model.frame(jackFn(params(bds[[2]]),params(jks[[2]]))$bias)),
           cbind("Scenario"=names(bds)[3],model.frame(jackFn(params(bds[[3]]),params(jks[[3]]))$bias)),
           cbind("Scenario"=names(bds)[4],model.frame(jackFn(params(bds[[4]]),params(jks[[4]]))$bias)))[,-c(4:5,8)]

biasRef=rbind(cbind("Scenario"=names(bds)[1],model.frame(jackFn(refpts(bds[[1]]),refpts(jks[[1]]))$bias)),
              cbind("Scenario"=names(bds)[2],model.frame(jackFn(refpts(bds[[2]]),refpts(jks[[2]]))$bias)),
              cbind("Scenario"=names(bds)[3],model.frame(jackFn(refpts(bds[[3]]),refpts(jks[[3]]))$bias)),
              cbind("Scenario"=names(bds)[4],model.frame(jackFn(refpts(bds[[4]]),refpts(jks[[4]]))$bias)))[,-5]

# biasB=rbind(cbind("Scenario"=names(bds)[1],model.frame(jackFn(stock(bds[[1]])[,"2012"]%/%refpts(bds[[1]])["bmsy"],
#                                                              stock(jks[[1]])[,"2012"]%/%refpts(jks[[1]])["bmsy"])$bias)),
#            cbind("Scenario"=names(bds)[2],model.frame(jackFn(stock(bds[[2]])[,"2012"]%/%refpts(bds[[2]])["bmsy"],
#                                                              stock(jks[[2]])[,"2012"]%/%refpts(jks[[2]])["bmsy"])$bias)),
#            cbind("Scenario"=names(bds)[3],model.frame(jackFn(stock(bds[[3]])[,"2012"]%/%refpts(bds[[3]])["bmsy"],
#                                                              stock(jks[[3]])[,"2012"]%/%refpts(jks[[3]])["bmsy"])$bias)),
#            cbind("Scenario"=names(bds)[4],model.frame(jackFn(stock(bds[[4]])[,"2012"]%/%refpts(bds[[4]])["bmsy"],
#                                                              stock(jks[[4]])[,"2012"]%/%refpts(jks[[4]])["bmsy"])$bias)))

#biasF=rbind(cbind("Scenario"=names(bds)[1],model.frame(jackFn(harvest(bds[[1]])[,"2011"]%/%refpts(bds[[1]])["fmsy"],
#                                                              harvest(jks[[1]])[,"2011"]%/%refpts(jks[[1]])["fmsy"])$bias)),
#            cbind("Scenario"=names(bds)[2],model.frame(jackFn(harvest(bds[[2]])[,"2011"]%/%refpts(bds[[2]])["fmsy"],
#                                                              harvest(jks[[2]])[,"2011"]%/%refpts(jks[[2]])["fmsy"])$bias)),
#            cbind("Scenario"=names(bds)[3],model.frame(jackFn(harvest(bds[[3]])[,"2011"]%/%refpts(bds[[3]])["fmsy"],
#                                                              harvest(jks[[3]])[,"2011"]%/%refpts(jks[[3]])["fmsy"])$bias)),
#            cbind("Scenario"=names(bds)[4],model.frame(jackFn(harvest(bds[[4]])[,"2011"]%/%refpts(bds[[4]])["fmsy"],
#                                                              harvest(jks[[4]])[,"2011"]%/%refpts(jks[[4]])["fmsy"])$bias)))
```
